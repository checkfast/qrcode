<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <link rel="manifest" href="manifest.json">
  <title>CheckFast – QR-Code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="robots" content="noindex, nofollow">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      background:#2b384b;
      color:#fff;
      margin:0;
      padding:15px;
    }
    h1{
      text-align:center;
      font-size:22px;
      margin-bottom:20px;
    }
    .card{
      background:#1f2937;
      border-radius:10px;
      padding:15px;
      margin-bottom:15px;
    }
    #searchBox{
      padding:12px;
      border-radius:8px;
      border:none;
      width:70%;
      margin:6px auto;
      display:block;
      font-size:18px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:18px;
    }
    th,td{
      padding:14px;
      border-bottom:1px solid #444;
    }
    th{
      background:#374151;
      text-align:left;
    }
    tr{
      cursor:pointer;
    }
    tr:hover{
      background:#4b5563;
    }
    tr.confirmed{
      background:#065f46!important;
      color:#fff;
    }
    button{
      padding:12px 14px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      margin:6px;
      font-size:16px;
    }
    button.primary{background:#e52013;color:#fff}
    button.ok{background:#16a34a;color:#fff}
    .counter{
      margin-top:10px;
      font-size:20px;
      text-align:center;
    }
    .hidden{display:none}
    .popupConfirm{
      position:fixed;
      top:15%;
      left:50%;
      transform:translateX(-50%);
      background:#16a34a;
      color:#fff;
      padding:30px 40px;
      border-radius:12px;
      font-size:26px;
      font-weight:bold;
      display:none;
      z-index:99999;
      text-align:center;
      box-shadow:0 6px 20px rgba(0,0,0,0.6);
      animation:pop .3s ease-out;
    }
    @keyframes pop{
      from{transform:translateX(-50%) scale(.9);opacity:0}
      to{transform:translateX(-50%) scale(1);opacity:1}
    }
    .actionsBottom{
      text-align:center;
      margin-top:20px;
    }
    .actionsBottom button{
      min-width:140px;
      margin:6px;
      font-size:15px;
      padding:6px 8px;
      border-radius:6px;
      color:#fff;
    }
    #showListBtn{background:#2563eb}
    #reportBtn{background:#d97706}
    #resetBtn{background:#dc2626}

    .logoBox{
      width:100%;
      text-align:center;
      margin-bottom:15px;
    }
    .logoImg{
      max-width:150px;
      height:auto;
      filter:brightness(1);
    }

    /* Modal password */
    .modal{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
      visibility:hidden;
      opacity:0;
      transition:opacity .3s;
    }
    .modal.show{
      visibility:visible;
      opacity:1;
    }
    .modal-content{
      background:#1f2937;
      padding:20px;
      border-radius:12px;
      text-align:center;
      width:300px;
    }
    .modal h2{
      margin:0 0 15px;
      font-size:20px;
    }
    .modal input{
      width:100%;
      font-size:22px;
      padding:12px;
      border-radius:8px;
      border:none;
      text-align:center;
      margin-bottom:15px;
      background:#fff;
      color:#000;
    }
    .keypad{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      margin-bottom:15px;
    }
    .keypad button{
      font-size:22px;
      padding:15px;
      border-radius:8px;
      background:#374151;
      color:#fff;
    }
    .modal .actions{
      display:flex;
      justify-content:space-between;
    }
    .modal button.action{
      width:48%;
      font-size:18px;
    }

    /* Schermata sblocco audio */
    #audioUnlock{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,0.75);
      backdrop-filter:blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      color:#fff;
      z-index:999999;
      text-align:center;
      padding:20px;
    }
  </style>
</head>
<body>

  <!-- Schermata iniziale per sbloccare l'audio -->
  <div id="audioUnlock">
    Tocca o clicca qui per iniziare
  </div>

  <div class="logoBox">
    <img src="https://static.wixstatic.com/media/2080b2_c720113f580945f180c59c84603d1ad8~mv2.png" alt="Logo" class="logoImg">
  </div>

  <h1>CHECK-IN – QR-Code</h1>

  <div class="card hidden" id="toolsCard">
    <!-- Campo sempre attivo per lo scanner -->
    <input type="text" id="searchBox" placeholder="Cerca ospite…" autofocus>
    <div class="counter">
      <span id="countChecked">0</span> / <span id="countTotal">0</span>
    </div>
    <div class="actionsBottom" id="exportCard">
      <button id="showListBtn">Mostra/Nascondi</button>
      <button id="reportBtn">Report</button>
      <button id="resetBtn">Reset</button>
    </div>
  </div>

  <div class="card hidden" id="tableCard">
    <table id="dataTable">
      <thead><tr><th>Ospite</th><th>Colore</th><th>Invitato</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- Banner -->
  <div class="popupConfirm" id="popupConfirm">Ospite Accreditato</div>

  <!-- Modal password reset -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h2>Inserisci Password</h2>
      <input type="password" id="passwordInput" readonly>
      <div class="keypad">
        <button>1</button><button>2</button><button>3</button>
        <button>4</button><button>5</button><button>6</button>
        <button>7</button><button>8</button><button>9</button>
        <button>←</button><button>0</button><button>OK</button>
      </div>
      <div class="actions">
        <button class="action ok" id="modalConfirm">Conferma</button>
        <button class="action primary" id="modalCancel">Annulla</button>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG GOOGLE SHEET / WEB APP ===== */
const sheetURL = "https://script.google.com/macros/s/AKfycbwsAe7lZZY6CfWXitxybapI-mm66ot2gOH_DucpbtpKxEjUINgTAqFK1QUcArZGr5IG-g/exec";

/* ===== VARIABILI ===== */
let rawRows = [];
let listVisible = false;
let scannerMode = true; // per tenere attivo il campo cerca, tranne quando è aperto il modal
let noMatchTimer = null; // solo per “non esiste”
let audioCtx = null;     // Web Audio context (creato dopo il click iniziale)

const searchBox     = document.getElementById('searchBox');
const tbody         = document.getElementById('tbody');
const toolsCard     = document.getElementById('toolsCard');
const tableCard     = document.getElementById('tableCard');
const countChecked  = document.getElementById('countChecked');
const countTotal    = document.getElementById('countTotal');
const popupConfirm  = document.getElementById('popupConfirm');
const showListBtn   = document.getElementById('showListBtn');
const reportBtn     = document.getElementById('reportBtn');
const resetBtn      = document.getElementById('resetBtn');
const modal         = document.getElementById('passwordModal');
const passwordInput = document.getElementById('passwordInput');
const modalConfirm  = document.getElementById('modalConfirm');
const modalCancel   = document.getElementById('modalCancel');
const unlockScreen  = document.getElementById('audioUnlock');

/* ===== SBLOCCO AUDIO SU PRIMO CLICK (creiamo AudioContext) ===== */
if (unlockScreen) {
  const unlockHandler = () => {
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }catch(e){
      console.warn("Web Audio non supportato", e);
    }
    unlockScreen.style.display = "none";
    unlockScreen.removeEventListener('click', unlockHandler);
    focusSearchBox();
  };
  unlockScreen.addEventListener('click', unlockHandler);
}

/* ===== FUNZIONE PER EMETTERE UN BEEP (WEB AUDIO) ===== */
function playBeep({frequency = 440, duration = 0.15, type = "sine", volume = 0.2, repeat = 1, gap = 0.08} = {}){
  if(!audioCtx) return; // se l'utente non ha cliccato, niente audio
  const now = audioCtx.currentTime;

  for(let i=0;i<repeat;i++){
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = type;
    osc.frequency.setValueAtTime(frequency, now + i*(duration+gap));

    gain.gain.setValueAtTime(0, now + i*(duration+gap));
    gain.gain.linearRampToValueAtTime(volume, now + i*(duration+gap) + 0.01);
    gain.gain.linearRampToValueAtTime(0,    now + i*(duration+gap) + duration);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now + i*(duration+gap));
    osc.stop(now + i*(duration+gap) + duration + 0.05);
  }
}

/* ===== GESTIONE FOCUS PER SCANNER ===== */
function focusSearchBox(){
  if(!scannerMode) return;
  if(!searchBox) return;
  searchBox.focus();
  const val = searchBox.value || "";
  try{
    searchBox.setSelectionRange(val.length, val.length);
  }catch(e){}
}

window.addEventListener('load', focusSearchBox);
window.addEventListener('focus', focusSearchBox);
searchBox.addEventListener('blur', () => {
  setTimeout(focusSearchBox, 50);
});

/* ===== BANNER NOTIFICA + SUONI ===== */
function showBanner(msg, type="ok"){
  if(type === "error" || type === "warn"){
    popupConfirm.style.background = (type === "error") ? "#dc2626" : "#d97706";
  } else {
    popupConfirm.style.background = "#16a34a";
  }
  popupConfirm.textContent = msg;
  popupConfirm.style.display = "block";

  // suono in base al tipo
  try{
    if(type === "error"){
      // errore: beep GRAVE + SUPER LUNGO + VOLUME ALTO
      playBeep({
        frequency: 180,     // più grave
        duration: 0.60,     // molto più lungo
        type: "sine",
        volume: 0.45,       // volume alto
        repeat: 1
      });
    } else if(type === "warn"){
      // già registrato: doppio beep medio
      playBeep({
        frequency: 440,
        duration: 0.12,
        type:"square",
        volume:0.22,
        repeat:2,
        gap:0.07
      });
    } else {
      // ok: beep singolo acuto e breve
      playBeep({
        frequency: 700,
        duration: 0.10,
        type:"square",
        volume:0.2,
        repeat:1
      });
    }
  }catch(e){}

  setTimeout(()=>{ popupConfirm.style.display = "none"; }, 2000);
}

/* ===== CARICAMENTO LISTA ===== */
async function caricaLista(){
  try{
    let res  = await fetch(sheetURL + "?action=list");
    let data = await res.json();
    rawRows  = data;
    renderTable();
    toolsCard.classList.remove('hidden');
    focusSearchBox();
  }catch(err){
    console.error("Errore caricamento:", err);
  }
}

/* ===== INVIO INGRESSO ===== */
async function confermaOspite(dati){
  try{
    await fetch(sheetURL,{
      method:"POST",
      headers:{"Content-Type":"text/plain"},
      body:JSON.stringify({
        action: "ingresso",
        nominativo: dati.nominativo,
        colore: dati.colore || ""
      })
    });
  }catch(err){
    console.error("Errore POST:", err);
  }
}

/* ===== RENDER TABELLA ===== */
function renderTable(){
  tbody.innerHTML = '';
  const qRaw = searchBox.value || '';
  const q    = qRaw.toLowerCase();
  const showAllBySpace = (qRaw === ' ');

  let rows = [];
  if(listVisible || showAllBySpace){
    rows = rawRows;
  } else if(q.trim().length > 0){
    rows = rawRows.filter(r=>{
      return String(r.nominativo??'').toLowerCase().includes(q) ||
             String(r.colore??'').toLowerCase().includes(q) ||
             String(r.invitato??'').toLowerCase().includes(q);
    });
  }

  if(rows.length>0){ tableCard.classList.remove('hidden'); }
  else{ tableCard.classList.add('hidden'); }

  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.nominativo || ''}</td><td>${r.colore || ''}</td><td>${r.invitato || ''}</td>`;

    const giaConfermato = r.ingresso && String(r.ingresso).trim() !== "";
    if(giaConfermato){
      tr.classList.add('confirmed');
    }

    // click manuale sulla riga = tenta check-in
    tr.addEventListener('click', () => {
      handleCheckinByRow(r);
    });

    tbody.appendChild(tr);
  });

  const c = rawRows.filter(r => r.ingresso && String(r.ingresso).trim() !== "").length;
  countChecked.textContent = c;
  countTotal.textContent   = rawRows.length;
}

/* ===== LOGICA CHECK-IN (USATA DA SCANNER E CLICK RIGA) ===== */
function handleCheckinByRow(row){
  if(!row) return;

  const giaConfermato = row.ingresso && String(row.ingresso).trim() !== "";

  if(giaConfermato){
    // già in report → subito
    showBanner("Ospite già registrato", "warn");
    searchBox.value = "";
    focusSearchBox();
    return;
  }

  // registra ingresso
  confermaOspite(row);
  showBanner("Ospite accreditato", "ok");
  searchBox.value = "";
  focusSearchBox();

  // ricarico la lista dopo 1 secondo
  setTimeout(caricaLista, 1000);
}

/* ===== PROCESS SCAN (usa SOLO match esistenti) ===== */
function processScan(value){
  const scanned = (value || "").trim();
  if(!scanned) return;

  const lowered = scanned.toLowerCase();
  const row = rawRows.find(r =>
    String(r.nominativo || "").trim().toLowerCase() === lowered
  );

  if(!row){
    // niente match: il “non esiste” è gestito dal timer, non qui
    return;
  }

  handleCheckinByRow(row);
}

/* ===== AUTO-SCAN: MATCH SUBITO, “NON ESISTE” DOPO 2s ===== */
function autoScanCheck(){
  if(noMatchTimer){
    clearTimeout(noMatchTimer);
    noMatchTimer = null;
  }

  if(!rawRows || rawRows.length === 0) return;

  const value = (searchBox.value || "").trim();
  if(!value) return;

  const lowered = value.toLowerCase();

  // 1) se esiste almeno un match → check-in immediato
  const matchRow = rawRows.find(r =>
    String(r.nominativo || "").trim().toLowerCase() === lowered
  );

  if(matchRow){
    processScan(value);  // qui gestiamo anche “già registrato”
    return;
  }

  // 2) se NON esiste match → parte SOLO il timer di 2 secondi per “non esiste”
  noMatchTimer = setTimeout(() => {
    const current = (searchBox.value || "").trim();
    if(!current) return;

    const currLower = current.toLowerCase();
    const stillMatch = rawRows.find(r =>
      String(r.nominativo || "").trim().toLowerCase() === currLower
    );

    // se ancora nessun match dopo 2s → davvero non esiste
    if(!stillMatch){
      showBanner("Ospite non presente in lista", "error");
      searchBox.value = "";
      focusSearchBox();
    }
  }, 2000);
}

/* ===== EVENTI INPUT / TASTIERA ===== */
searchBox.addEventListener('input', () => {
  // ricerca manuale
  renderTable();
  // logica scanner (match subito, non esiste dopo 2s)
  autoScanCheck();
});

// ENTER: stessa logica (comodo se scrivi a mano)
searchBox.addEventListener('keydown', (e) => {
  if(e.key === "Enter"){
    e.preventDefault();
    autoScanCheck();
  }
});

/* ===== BOTTONI ===== */
showListBtn.addEventListener('click', () => {
  listVisible = !listVisible;
  if(listVisible) searchBox.value = "";
  renderTable();
  focusSearchBox();
});

reportBtn.addEventListener('click', () => {
  const ws = XLSX.utils.json_to_sheet(rawRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Report');
  XLSX.writeFile(wb,'report_completo.xlsx');
});

/* RESET CON PASSWORD (2006) */
resetBtn.addEventListener('click', () => {
  scannerMode = false;       // sospendo il focus automatico
  modal.classList.add('show');
  passwordInput.value = "";
});

modalCancel.addEventListener('click', () => {
  modal.classList.remove('show');
  scannerMode = true;
  focusSearchBox();
});

document.querySelectorAll('.keypad button').forEach(btn => {
  btn.addEventListener('click', () => {
    let val = btn.textContent;
    if(val === '←'){
      passwordInput.value = passwordInput.value.slice(0,-1);
    } else if(val === 'OK'){
      modalConfirm.click();
    } else {
      passwordInput.value += val;
    }
  });
});

modalConfirm.addEventListener('click', () => {
  if(passwordInput.value === "2006"){
    modal.classList.remove('show');
    location.reload(true);
  } else {
    alert("Password errata");
  }
});

/* ===== AVVIO ===== */
caricaLista();
setInterval(caricaLista, 5000); // aggiorna ogni 5s
</script>
</body>
</html>
